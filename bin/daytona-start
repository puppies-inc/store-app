#!/usr/bin/env bash

set -euo pipefail

DAYTONA_DB_NAME="${DAYTONA_DB_NAME:-store_development}"
DAYTONA_DB_USER="${DAYTONA_DB_USER:-store}"
DAYTONA_DB_PASSWORD="${DAYTONA_DB_PASSWORD:-store}"

echo "Starting PostgreSQL..."
PG_VERSION="$(pg_lsclusters --no-header | awk 'NR==1 { print $1 }')"
if [ -z "${PG_VERSION}" ]; then
  echo "No PostgreSQL cluster found." >&2
  exit 1
fi
pg_ctlcluster "${PG_VERSION}" main start

echo "Waiting for PostgreSQL to accept connections..."
until pg_isready -h 127.0.0.1 -U postgres >/dev/null 2>&1; do
  sleep 1
done

if ! runuser -u postgres -- psql -tAc "SELECT 1 FROM pg_roles WHERE rolname='${DAYTONA_DB_USER}'" | grep -q 1; then
  runuser -u postgres -- psql -v ON_ERROR_STOP=1 -c "CREATE ROLE ${DAYTONA_DB_USER} LOGIN PASSWORD '${DAYTONA_DB_PASSWORD}';"
fi

if ! runuser -u postgres -- psql -tAc "SELECT 1 FROM pg_database WHERE datname='${DAYTONA_DB_NAME}'" | grep -q 1; then
  runuser -u postgres -- createdb -O "${DAYTONA_DB_USER}" "${DAYTONA_DB_NAME}"
fi

if [ -z "${DATABASE_URL:-}" ]; then
  export DATABASE_URL="postgres://${DAYTONA_DB_USER}:${DAYTONA_DB_PASSWORD}@127.0.0.1:5432/${DAYTONA_DB_NAME}"
fi

cd /workspaces/store
bin/rails db:prepare

if [ "$#" -eq 0 ]; then
  set -- bin/dev
fi

exec "$@"
